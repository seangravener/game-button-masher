# SSL Setup Guide for Button Smasher

This guide explains how to deploy Button Smasher with HTTPS using Let's Encrypt SSL certificates.

## Overview

The SSL setup uses:
- **Nginx** as a reverse proxy
- **Certbot** for Let's Encrypt SSL certificates
- **Automatic certificate renewal** every 12 hours

## Prerequisites

### For SSL to work, you MUST have:

1. **A domain name** (e.g., `game.example.com`)
2. **DNS configured** - Domain must point to your server's public IP
3. **Open ports**:
   - Port 80 (HTTP) - Required for Let's Encrypt verification
   - Port 443 (HTTPS) - For secure connections
4. **Public server** - Must be accessible from the internet

### Check if you're ready:

```bash
# 1. Check if your domain resolves correctly
dig +short yourdomain.com

# 2. Check if ports are open (run from another machine)
nc -zv your-server-ip 80
nc -zv your-server-ip 443

# 3. Make sure firewall allows ports 80 and 443
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
```

## Quick Start

### Option 1: Interactive Setup Script (Recommended)

```bash
# Run the interactive setup script
./setup-ssl.sh
```

The script will:
1. Ask if you want SSL (or HTTP-only)
2. Prompt for your domain name
3. Prompt for your email (for Let's Encrypt notifications)
4. Validate your domain
5. Obtain SSL certificate
6. Configure Nginx with HTTPS
7. Start all services

**Example interaction:**
```
Enable SSL? (y/n): y
Enter your domain name: game.example.com
Enter your email: you@example.com
```

### Option 2: Manual Setup

If you prefer manual control:

```bash
# 1. Create certificate directories
mkdir -p certbot/www certbot/conf

# 2. Copy HTTP-only config initially
cp nginx/conf/http-only.conf nginx/conf/active.conf

# 3. Start services (HTTP only)
podman-compose -f docker-compose.ssl.yml up -d

# 4. Obtain certificate manually
podman-compose -f docker-compose.ssl.yml run --rm certbot certonly \
  --webroot \
  --webroot-path=/var/www/certbot \
  --email your-email@example.com \
  --agree-tos \
  --no-eff-email \
  -d yourdomain.com

# 5. Update nginx/conf/active.conf with SSL configuration
# (See example below)

# 6. Restart nginx
podman-compose -f docker-compose.ssl.yml restart nginx
```

## Running Without SSL (HTTP Only)

If you don't have a domain or just want to test locally:

```bash
# Use the standard docker-compose
podman-compose up -d

# Access at http://localhost:3000
```

## File Structure

```
game-button-smasher/
├── docker-compose.yml           # HTTP-only setup
├── docker-compose.ssl.yml       # HTTPS setup with Nginx + Certbot
├── setup-ssl.sh                 # Interactive SSL setup script
├── nginx/
│   └── conf/
│       ├── http-only.conf       # Simple HTTP configuration
│       ├── default.conf.template # Template for customization
│       └── active.conf          # Active config (generated by script)
└── certbot/
    ├── www/                     # ACME challenge files
    └── conf/                    # SSL certificates and keys
```

## SSL Configuration Details

### What the setup does:

1. **HTTP (Port 80)**:
   - Serves ACME challenges for certificate validation
   - Redirects all other traffic to HTTPS

2. **HTTPS (Port 443)**:
   - Serves your application over SSL
   - Modern TLS 1.2/1.3 configuration
   - Security headers enabled
   - WebSocket support for Socket.IO

3. **Auto-renewal**:
   - Certbot checks for renewal every 12 hours
   - Nginx reloads every 6 hours to pick up new certificates
   - No manual intervention needed

## Managing SSL Certificates

### View certificate info
```bash
podman-compose -f docker-compose.ssl.yml exec certbot \
  certbot certificates
```

### Manual renewal (not usually needed)
```bash
podman-compose -f docker-compose.ssl.yml run --rm certbot \
  certbot renew
```

### Renew and reload Nginx
```bash
podman-compose -f docker-compose.ssl.yml run --rm certbot certbot renew
podman-compose -f docker-compose.ssl.yml restart nginx
```

### Add additional domains
```bash
podman-compose -f docker-compose.ssl.yml run --rm certbot certonly \
  --webroot \
  --webroot-path=/var/www/certbot \
  --email your-email@example.com \
  --agree-tos \
  -d domain1.com \
  -d domain2.com \
  -d www.domain1.com
```

## Troubleshooting

### SSL certificate failed to obtain

**Check DNS resolution:**
```bash
dig +short yourdomain.com
nslookup yourdomain.com
```

**Verify ports are accessible:**
```bash
# From another machine or https://www.yougetsignal.com/tools/open-ports/
curl -I http://yourdomain.com
```

**Check firewall:**
```bash
sudo ufw status
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
```

**View Certbot logs:**
```bash
podman-compose -f docker-compose.ssl.yml logs certbot
```

### Certificate obtained but site not working

**Check Nginx logs:**
```bash
podman-compose -f docker-compose.ssl.yml logs nginx
```

**Verify certificate files exist:**
```bash
ls -la certbot/conf/live/yourdomain.com/
```

**Test Nginx config:**
```bash
podman-compose -f docker-compose.ssl.yml exec nginx nginx -t
```

### Certificate expired

Certificates should auto-renew, but if something went wrong:

```bash
# Force renewal
podman-compose -f docker-compose.ssl.yml run --rm certbot \
  certbot renew --force-renewal

# Restart nginx to use new cert
podman-compose -f docker-compose.ssl.yml restart nginx
```

### WebSocket connection issues over HTTPS

Make sure your client connects using `wss://` (not `ws://`):

```javascript
// In your client code
const socket = io('https://yourdomain.com', {
  transports: ['websocket', 'polling']
});
```

### Mixed content warnings

Ensure all resources (scripts, CSS, images) are loaded over HTTPS:
```html
<!-- Bad -->
<script src="http://example.com/script.js"></script>

<!-- Good -->
<script src="https://example.com/script.js"></script>
<!-- Or use protocol-relative URLs -->
<script src="//example.com/script.js"></script>
```

## Switching Between HTTP and HTTPS

### From HTTP to HTTPS:
```bash
./setup-ssl.sh
# Answer 'y' to enable SSL
```

### From HTTPS to HTTP:
```bash
# Stop SSL services
podman-compose -f docker-compose.ssl.yml down

# Start HTTP-only
podman-compose up -d
```

## Security Best Practices

1. **Keep services updated:**
   ```bash
   podman-compose -f docker-compose.ssl.yml pull
   podman-compose -f docker-compose.ssl.yml up -d
   ```

2. **Monitor certificate expiration:**
   ```bash
   podman-compose -f docker-compose.ssl.yml exec certbot \
     certbot certificates
   ```

3. **Check SSL configuration:**
   - Use [SSL Labs](https://www.ssllabs.com/ssltest/) to test your HTTPS setup
   - Should get an A or A+ rating

4. **Enable firewall:**
   ```bash
   sudo ufw enable
   sudo ufw allow 22/tcp   # SSH
   sudo ufw allow 80/tcp   # HTTP
   sudo ufw allow 443/tcp  # HTTPS
   ```

5. **Regular backups of certificates:**
   ```bash
   tar -czf certbot-backup-$(date +%Y%m%d).tar.gz certbot/conf/
   ```

## Production Deployment Checklist

- [ ] Domain points to server's public IP
- [ ] Ports 80 and 443 are open
- [ ] Firewall configured
- [ ] SSL certificate obtained successfully
- [ ] HTTPS redirects working
- [ ] WebSocket connections work over WSS
- [ ] SSL rating checked (SSL Labs)
- [ ] Auto-renewal tested
- [ ] Monitoring/alerts set up
- [ ] Backups configured

## Cost

Let's Encrypt certificates are **completely free**! They:
- Last for 90 days
- Auto-renew every 60 days (handled by Certbot)
- Support unlimited domains/subdomains
- Are trusted by all major browsers

## Support

If you encounter issues:
1. Check the [Troubleshooting](#troubleshooting) section above
2. Review logs: `podman-compose -f docker-compose.ssl.yml logs`
3. Verify prerequisites are met
4. Check [Let's Encrypt Community](https://community.letsencrypt.org/)

## Additional Resources

- [Let's Encrypt Documentation](https://letsencrypt.org/docs/)
- [Certbot Documentation](https://certbot.eff.org/docs/)
- [Nginx SSL Configuration Generator](https://ssl-config.mozilla.org/)
- [SSL Labs Testing](https://www.ssllabs.com/ssltest/)
