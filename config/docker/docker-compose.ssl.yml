version: "3.8"

services:
  # Main application
  button-smasher:
    build:
      context: ../..
      dockerfile: config/docker/Dockerfile
    container_name: button-smasher
    environment:
      - NODE_ENV=production
      - PORT=3000
    restart: unless-stopped
    networks:
      - app-network
    # Don't expose port directly - only through nginx
    expose:
      - "3000"
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: "1"
          memory: 512M
        reservations:
          cpus: "0.25"
          memory: 128M

  # Nginx reverse proxy
  nginx:
    image: docker.io/library/nginx:1.25-alpine
    container_name: button-smasher-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ../../config/nginx/conf/active.conf:/etc/nginx/conf.d/default.conf:ro
      - ../../certbot/www:/var/www/certbot:ro
      - ../../certbot/conf:/etc/letsencrypt:ro
    depends_on:
      - button-smasher
    networks:
      - app-network
    restart: unless-stopped
    command: '/bin/sh -c ''while :; do sleep 6h & wait $${!}; nginx -s reload; done & nginx -g "daemon off;"'''
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:80/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Certbot for SSL certificates (auto-renewal)
  certbot:
    image: docker.io/certbot/certbot:latest
    container_name: button-smasher-certbot
    volumes:
      - ../../certbot/www:/var/www/certbot:rw
      - ../../certbot/conf:/etc/letsencrypt:rw
    depends_on:
      - nginx
    networks:
      - app-network
    # Wait for initial cert, then start renewal daemon
    entrypoint: >
      /bin/sh -c '
      trap exit TERM;
      echo "Certbot: Waiting for initial certificate...";
      TIMEOUT=1800;
      ELAPSED=0;
      while [ ! -f /etc/letsencrypt/live/*/fullchain.pem ] && [ $$ELAPSED -lt $$TIMEOUT ]; do
        echo "Certbot: Certificate not found yet, waiting... ($$ELAPSED/$$TIMEOUT seconds)";
        sleep 10;
        ELAPSED=$$((ELAPSED + 10));
      done;
      if [ ! -f /etc/letsencrypt/live/*/fullchain.pem ]; then
        echo "Certbot: ERROR - Timeout waiting for initial certificate after $$TIMEOUT seconds";
        exit 1;
      fi;
      echo "Certbot: Certificate found! Starting renewal daemon...";
      while :; do
        echo "Certbot: Checking for certificate renewal...";
        certbot renew --webroot -w /var/www/certbot --quiet;
        echo "Certbot: Next renewal check in 12 hours";
        sleep 12h & wait $${!};
      done;
      '
    restart: unless-stopped

networks:
  app-network:
    driver: bridge
